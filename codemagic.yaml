workflows:
  ios-qt6-cmake-workflow:
    name: Build MIRA_Client iOS
    max_build_duration: 60
    instance_type: mac_mini_m1
    environment:
      vars:
        QT_VERSION: "6.6.0"
      xcode: latest
    scripts:
      - name: Install Qt6 for iOS and macOS
        script: |
          pip3 install aqtinstall
          # تثبيت نسخة الماك (للأدوات) ونسخة الأيفون (للمكتبات)
          aqt install-qt mac desktop $QT_VERSION
          aqt install-qt mac ios $QT_VERSION
      - name: Configure and Build MIRA_Client
        script: |
          # 1. تحديد المسارات المطلقة لضمان العثور على Qt
          QT_PREFIX=$ROOT_DIR/6.6.0/ios
          QT_HOST_PREFIX=$ROOT_DIR/6.6.0/macos
          
          # 2. إضافة مسارات Qt إلى بيئة النظام (مهم جداً لـ CMake)
          export PATH=$QT_HOST_PREFIX/bin:$QT_PREFIX/bin:$PATH
          
          # 3. الدخول لمجلد المشروع الحقيقي
          cd MIRA/client
          
          # 4. تنظيف أي محاولات بناء سابقة وإنشاء مجلد جديد
          rm -rf build
          mkdir build && cd build
          
          # 5. أمر CMake الذهبي (يجمع بين مسار المكتبات ومسار الأدوات)
          cmake .. \
            -G Xcode \
            -DCMAKE_PREFIX_PATH=$QT_PREFIX \
            -DQT_HOST_PATH=$QT_HOST_PREFIX \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_XCODE_ATTRIBUTE_ONLY_ACTIVE_ARCH=NO \
            -DQt6_DIR=$QT_PREFIX/lib/cmake/Qt6
          
          # 6. البناء الفعلي وتوليد ملف التطبيق
          cmake --build . --config Release -- -sdk iphoneos
    artifacts:
      - MIRA/client/build/Release-iphoneos/*.app
      - MIRA/client/build/**/*.ipa